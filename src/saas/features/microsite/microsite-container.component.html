<div
    class="flex flex-col h-[calc(100vh-140px)] bg-white/10 backdrop-blur-2xl rounded-2xl shadow-2xl overflow-hidden border border-white/20 animate-fade-in relative">

    <!-- Notification -->
    @if (saveMessage()) {
    <div
        class="fixed top-4 right-4 bg-emerald-500 text-white px-6 py-3 rounded-xl shadow-2xl z-50 animate-bounce border border-white/20 backdrop-blur-md font-bold">
        {{ saveMessage() | translate }}
    </div>
    }

    <!-- Header -->
    <div class="bg-black/20 border-b border-white/10 p-4 flex justify-between items-center backdrop-blur-sm">
        <div class="flex items-center space-x-3">
            <!-- Close Button (Dispatches custom event looking for parent handler or we use a directive? 
                 In AngleView call, it was (click)="closeTool()". 
                 We need to expose an Output, but for now we expect the container to be projected or handled by parent.
                 Let's add an Output logic in TS later if we strictly need it, 
                 but for checking, let's assume the Parent handles the "close" by unmounting this component.
                 Wait, this button needs to trigger the parent. 
                 I'll add an @Output close = new EventEmitter<void>(); in TS next step if needed. 
                 For now, let's just emit a simple event. -->
            <button (click)="close.emit()" [attr.title]="'COMMON.Back' | translate"
                [attr.aria-label]="'COMMON.Back' | translate"
                class="text-slate-300 hover:text-white bg-white/10 p-2 rounded-full hover:bg-white/20 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                </svg>
            </button>
            <h2 class="text-lg font-bold text-white tracking-wide">{{ 'MICROSITE.EditorTitle' | translate }}</h2>
        </div>
        <div class="flex space-x-3">
            <button (click)="saveMicrosite()"
                class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-xl font-bold shadow-lg shadow-green-900/20 transition-all flex items-center border border-green-400/50">
                {{ 'MICROSITE.Publish' | translate }}
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <!-- Left Palette (Darker Glass for contrast) -->
        <aside
            class="w-80 bg-black/20 border-r border-white/10 overflow-y-auto p-6 space-y-8 flex-shrink-0 backdrop-blur-md custom-scrollbar">

            <!-- AI Auto-Design -->
            <div class="bg-indigo-900/40 p-4 rounded-xl border border-indigo-500/30 shadow-inner"
                [class.opacity-50]="!hasAiAccess()">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-sm font-bold text-indigo-100">{{ 'MICROSITE.AssistantTitle' | translate }}</h3>
                    @if(!hasAiAccess()) {
                    <span
                        class="bg-white/10 text-white border border-white/20 text-[10px] px-2 py-0.5 rounded-full font-bold">Silver+</span>
                    }
                </div>
                <p class="text-xs text-indigo-200 mb-3 font-light">{{ 'MICROSITE.AssistantDesc' | translate }}
                </p>
                <button (click)="generateMicrositeWithAI()" [disabled]="isAiDesigning() || !hasAiAccess()"
                    [title]="'MICROSITE.AutoDesign' | translate" [attr.aria-label]="'MICROSITE.AutoDesign' | translate"
                    class="w-full py-2 rounded-lg text-sm font-semibold flex items-center justify-center transition-all shadow-sm border"
                    [class]="hasAiAccess() ? 'bg-indigo-600 border-indigo-400 hover:bg-indigo-500 text-white' : 'bg-white/5 border-white/10 text-slate-400 cursor-not-allowed'">
                    {{ isAiDesigning() ? ('MICROSITE.Creating' | translate) : ('MICROSITE.AutoDesign' | translate) }}
                </button>
            </div>

            <!-- Theme & Style -->
            <div class="space-y-4">
                <label class="block text-sm font-bold text-white uppercase tracking-wide opacity-80">{{
                    'MICROSITE.Appearance' | translate }}</label>

                <div>
                    <label class="text-xs text-slate-300 block mb-1">{{ 'MICROSITE.VisualTheme' | translate }}</label>
                    <select [id]="'theme-select'" [ngModel]="micrositeConfig().template"
                        (ngModelChange)="updateConfig('template', $event)" [title]="'MICROSITE.ThemeSelect' | translate"
                        class="w-full rounded-lg border-white/20 text-sm bg-white/10 text-white focus:bg-slate-800 focus:border-indigo-500 focus:ring-indigo-500">
                        @for(theme of themeOptions; track theme.id) {
                        <option [value]="theme.id" class="text-slate-900">{{ theme.label | translate }}</option>
                        }
                    </select>
                </div>

                <div>
                    <label class="text-xs text-slate-300 block mb-1">{{ 'MICROSITE.PrimaryColor' | translate }}</label>
                    <div class="flex space-x-2">
                        @for(color of ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#1e293b']; track
                        color) {
                        <button (click)="updateConfig('primaryColor', color)" [style.backgroundColor]="color"
                            [title]="'MICROSITE.ColorPick' | translate"
                            [class.ring-2]="micrositeConfig().primaryColor === color"
                            class="w-6 h-6 rounded-full border border-white/50 ring-offset-1 ring-offset-transparent ring-white shadow-sm hover:scale-110 transition-transform"></button>
                        }
                    </div>
                </div>
            </div>

            <!-- Content Config -->
            <div class="space-y-4">
                <label class="block text-sm font-bold text-white uppercase tracking-wide opacity-80">{{
                    'MICROSITE.PublicContent' | translate }}</label>

                <div>
                    <label class="text-xs text-slate-300 block mb-1">{{ 'MICROSITE.Headline' | translate }}</label>
                    <input type="text" [ngModel]="micrositeConfig().headline"
                        [title]="'MICROSITE.HeadlineLabel' | translate"
                        (ngModelChange)="updateConfig('headline', $event)"
                        class="w-full rounded-lg border-white/20 text-sm bg-white/10 text-white placeholder-slate-400 focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- Description Editor -->
                <div>
                    <label class="text-xs text-slate-300 block mb-1">{{ 'MICROSITE.Description' | translate }}</label>
                    <textarea [ngModel]="marketingText()" (ngModelChange)="marketingText.set($event)" rows="6"
                        class="w-full rounded-lg border-white/20 text-sm bg-white/10 text-white placeholder-slate-400 focus:border-indigo-500 focus:ring-indigo-500"
                        [placeholder]="'MICROSITE.DescriptionPlaceholder' | translate"></textarea>
                </div>

                <div class="pt-2 border-t border-white/10 mt-2 space-y-3">
                    <label class="text-xs text-slate-300 block font-bold uppercase tracking-wide mb-2">{{
                        'MICROSITE.Options' | translate }}</label>

                    <div class="flex items-center justify-between">
                        <label for="showDesc" class="block text-sm text-slate-200 cursor-pointer">{{
                            'MICROSITE.ShowDescription' | translate }}</label>
                        <div
                            class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" [checked]="micrositeConfig().showDescription"
                                (change)="toggleDescriptionVisibility($event)" id="showDesc"
                                class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                            <label for="showDesc"
                                class="toggle-label block overflow-hidden h-5 rounded-full bg-white/20 cursor-pointer"></label>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <label for="showContact" class="block text-sm text-slate-200 cursor-pointer">{{
                            'MICROSITE.ContactForm' | translate }}</label>
                        <div
                            class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" [checked]="micrositeConfig().showContact"
                                (change)="toggleContactForm($event)" id="showContact"
                                class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                            <label for="showContact"
                                class="toggle-label block overflow-hidden h-5 rounded-full bg-white/20 cursor-pointer"></label>
                        </div>
                    </div>
                </div>

                <!-- Section Selection & Ordering -->
                <div class="space-y-2 pt-2 border-t border-white/10">
                    <label class="text-xs text-slate-300 block font-bold uppercase tracking-wide">{{
                        'MICROSITE.SectionsToShow' | translate }}</label>
                    <div class="space-y-1 mb-4">
                        @for(section of availableSections; track section.id) {
                        <div class="flex items-center">
                            <input type="checkbox" [id]="'sec-' + section.id"
                                [title]="'MICROSITE.ToggleSection' | translate"
                                [checked]="micrositeConfig().visibleSections.includes(section.id)"
                                (change)="toggleSectionVisibility(section.id, $event)"
                                class="h-4 w-4 rounded border-slate-500 bg-white/10 text-indigo-500 focus:ring-indigo-500">
                            <label [for]="'sec-' + section.id" class="ml-2 block text-sm text-slate-200 cursor-pointer">
                                {{ section.label | translate }}
                            </label>
                        </div>
                        }
                    </div>

                    <label class="text-xs text-slate-300 block font-bold uppercase tracking-wide">{{
                        'MICROSITE.DisplayOrder' | translate }}</label>
                    <div class="bg-white/5 border border-white/10 rounded-lg divide-y divide-white/10 shadow-inner">
                        @for(section of orderedSections(); track section.id; let i = $index) {
                        <div class="flex items-center justify-between p-2 text-sm">
                            <span class="text-slate-200">{{ section.label | translate }}</span>
                            <div class="flex space-x-1">
                                <button (click)="moveSection(i, 'up')" [disabled]="i === 0"
                                    class="p-1 text-slate-400 hover:text-white disabled:opacity-30">‚Üë</button>
                                <button (click)="moveSection(i, 'down')" [disabled]="i === orderedSections().length - 1"
                                    class="p-1 text-slate-400 hover:text-white disabled:opacity-30">‚Üì</button>
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Content Editing -->
            @let visible = micrositeConfig().visibleSections;
            @let content = bookletContent();

            <div class="space-y-4 pt-4 border-t border-white/10">
                <label class="block text-sm font-bold text-white uppercase tracking-wide opacity-80">{{
                    'MICROSITE.ContentEditing' | translate }}</label>

                @if(visible.includes('guide')) {
                <div class="bg-white/5 p-3 rounded-lg border border-white/10">
                    <h4 class="text-xs font-bold text-slate-300 uppercase mb-2">{{ 'MICROSITE.LocalGuide' | translate }}
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1">{{ 'MICROSITE.Restaurants' |
                                translate }}</label>
                            <textarea rows="3" [ngModel]="content?.guideGastro?.recommandationRestaurants"
                                [title]="'MICROSITE.Restaurants' | translate"
                                (ngModelChange)="updateBookletText('guideGastro', 'recommandationRestaurants', $event)"
                                class="w-full text-xs rounded border-white/20 bg-white/10 text-white placeholder-slate-500"></textarea>
                        </div>
                        <!-- Add other guide fields here if needed per original code, kept brief for now as they are dynamically bound in the renderer via content object -->
                    </div>
                </div>
                }
            </div>

            <!-- Image Reordering -->
            <div class="pt-4 border-t border-white/10 mt-4">
                <label class="block text-sm font-bold text-white mb-2 uppercase tracking-wide opacity-80">{{
                    'MICROSITE.Photos' | translate }}</label>

                <div class="space-y-2 max-h-60 overflow-y-auto pr-1">
                    @if(micrositePhotos().length > 0) {
                    @for(photo of micrositePhotos(); track $index) {
                    <div class="flex items-center bg-white/10 p-2 rounded border border-white/10"
                        [class.opacity-50]="!photo.visible">
                        <!-- Controls -->
                        <button (click)="setCoverPhoto(photo.url)" class="mr-2 transition-colors"
                            [class.text-yellow-400]="micrositeConfig().headerPhotoUrl === photo.url"
                            [class.text-slate-500]="micrositeConfig().headerPhotoUrl !== photo.url">
                            ‚òÖ
                        </button>
                        <button (click)="togglePhotoVisibility($index)" class="mr-2 text-slate-400 hover:text-white">
                            {{ photo.visible ? 'üëÅÔ∏è' : 'üö´' }}
                        </button>

                        <img [src]="photo.url" alt="Gallery Photo Preview"
                            class="w-8 h-8 object-cover rounded mr-3 bg-black/50">
                        <div class="flex-grow min-w-0">
                            <p class="text-xs truncate text-slate-300">{{ photo.category || 'Photo' }}</p>
                        </div>
                    </div>
                    }
                    } @else {
                    <p class="text-sm italic text-slate-500">{{ 'MICROSITE.NoPhotos' | translate }}</p>
                    }
                </div>
            </div>
        </aside>

        <!-- Right Preview -->
        <main
            class="flex-1 bg-slate-900/50 overflow-y-auto flex items-start justify-center p-8 relative custom-scrollbar">
            <!-- Preview Wrapper -->
            <div
                class="w-full max-w-[1000px] h-auto bg-white shadow-2xl rounded-lg overflow-hidden ring-1 ring-white/10 mx-auto transition-all duration-500 will-change-transform transform origin-top hover:scale-[1.01]">

                <app-microsite-renderer [config]="micrositeConfig()" [content]="bookletContent()"
                    [photos]="visiblePhotos()" [propertyDetails]="propertyDetails()" [marketingText]="marketingText()"
                    [userEmail]="userEmail()">
                </app-microsite-renderer>
            </div>
        </main>
    </div>
</div>